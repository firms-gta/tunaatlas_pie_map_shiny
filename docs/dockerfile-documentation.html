<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 1 Dockerfile Documentation | Documentation-on-the-Dockerfile-and-the-YAML-for-the-Shiny-App.knit</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 1 Dockerfile Documentation | Documentation-on-the-Dockerfile-and-the-YAML-for-the-Shiny-App.knit" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="https://github.com/BastienIRD" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 1 Dockerfile Documentation | Documentation-on-the-Dockerfile-and-the-YAML-for-the-Shiny-App.knit" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="github-actions-yaml-documentation.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Documentation</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Documentation on the Dockerfile and the YAML for the Shiny App</a></li>
<li class="chapter" data-level="1" data-path="dockerfile-documentation.html"><a href="dockerfile-documentation.html"><i class="fa fa-check"></i><b>1</b> Dockerfile Documentation</a>
<ul>
<li class="chapter" data-level="1.1" data-path="dockerfile-documentation.html"><a href="dockerfile-documentation.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="dockerfile-documentation.html"><a href="dockerfile-documentation.html#final-steps"><i class="fa fa-check"></i><b>1.2</b> Final Steps</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html"><i class="fa fa-check"></i><b>2</b> GitHub Actions YAML Documentation</a>
<ul>
<li class="chapter" data-level="2.1" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html#set-up-docker-buildx"><i class="fa fa-check"></i><b>2.2</b> <strong>Set up Docker Buildx</strong></a></li>
<li class="chapter" data-level="2.3" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html#verify-docker-images"><i class="fa fa-check"></i><b>2.3</b> <strong>Verify Docker images</strong></a></li>
<li class="chapter" data-level="2.4" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html#inspect-docker-cache"><i class="fa fa-check"></i><b>2.4</b> <strong>Inspect Docker cache</strong></a></li>
<li class="chapter" data-level="2.5" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html#build-docker-image"><i class="fa fa-check"></i><b>2.5</b> <strong>Build Docker image</strong></a></li>
<li class="chapter" data-level="2.6" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html#load-docker-image"><i class="fa fa-check"></i><b>2.6</b> <strong>Load Docker image</strong></a></li>
<li class="chapter" data-level="2.7" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html#conditional-push-docker-image"><i class="fa fa-check"></i><b>2.7</b> <strong>Conditional push Docker image</strong></a></li>
<li class="chapter" data-level="2.8" data-path="github-actions-yaml-documentation.html"><a href="github-actions-yaml-documentation.html#conclusion"><i class="fa fa-check"></i><b>2.8</b> Conclusion</a></li>
</ul></li>
<li class="appendix"><span><b>Using Docker cache with Buildx and GHCR locally</b></span></li>
<li class="chapter" data-level="A" data-path="for-now-to-build-the-shiny-app-in-local.html"><a href="for-now-to-build-the-shiny-app-in-local.html"><i class="fa fa-check"></i><b>A</b> For now, to build the shiny app in local</a>
<ul>
<li class="chapter" data-level="A.1" data-path="for-now-to-build-the-shiny-app-in-local.html"><a href="for-now-to-build-the-shiny-app-in-local.html#to-run-the-image"><i class="fa fa-check"></i><b>A.1</b> To run the image</a></li>
<li class="chapter" data-level="A.2" data-path="for-now-to-build-the-shiny-app-in-local.html"><a href="for-now-to-build-the-shiny-app-in-local.html#to-run-the-image-passing-arguments-inside-as-a-db-connection"><i class="fa fa-check"></i><b>A.2</b> To run the image passing arguments inside as a DB connection:</a></li>
</ul></li>
<li class="part"><span><b>TO BE DONE</b></span></li>
<li class="chapter" data-level="B" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html"><i class="fa fa-check"></i><b>B</b> Using buildx to create the docker image in local and push</a>
<ul>
<li class="chapter" data-level="B.1" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#step-1-generate-a-personal-access-token-pat"><i class="fa fa-check"></i><b>B.1</b> Step 1: Generate a Personal Access Token (PAT)</a></li>
<li class="chapter" data-level="B.2" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#step-2-login-to-ghcr-locally"><i class="fa fa-check"></i><b>B.2</b> Step 2: Login to GHCR Locally</a></li>
<li class="chapter" data-level="B.3" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#step-3-create-a-event.json-file"><i class="fa fa-check"></i><b>B.3</b> Step 3: Create a <code>event.json</code> File</a></li>
<li class="chapter" data-level="B.4" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#step-4-verify-docker-buildx-installation"><i class="fa fa-check"></i><b>B.4</b> Step 4: Verify Docker Buildx Installation</a></li>
<li class="chapter" data-level="B.5" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#step-6-build-with-remote-cache-incoming"><i class="fa fa-check"></i><b>B.5</b> Step 6: Build with Remote Cache (Incoming)</a>
<ul>
<li class="chapter" data-level="B.5.1" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#explanation"><i class="fa fa-check"></i><b>B.5.1</b> Explanation</a></li>
</ul></li>
<li class="chapter" data-level="B.6" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#step-7-verify-cache-usage"><i class="fa fa-check"></i><b>B.6</b> Step 7: Verify Cache Usage</a></li>
<li class="chapter" data-level="B.7" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#step-8-run-locally-with-act"><i class="fa fa-check"></i><b>B.7</b> Step 8: Run Locally with <code>act</code></a></li>
<li class="chapter" data-level="B.8" data-path="using-buildx-to-create-the-docker-image-in-local-and-push.html"><a href="using-buildx-to-create-the-docker-image-in-local-and-push.html#additional-notes"><i class="fa fa-check"></i><b>B.8</b> Additional Notes</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="_blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dockerfile-documentation" class="section level1 hasAnchor" number="1">
<h1><span class="header-section-number">Chapter 1</span> Dockerfile Documentation<a href="dockerfile-documentation.html#dockerfile-documentation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction" class="section level2 hasAnchor" number="1.1">
<h2><span class="header-section-number">1.1</span> Introduction<a href="dockerfile-documentation.html#introduction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This document provides a detailed explanation of the Dockerfile used to set up and deploy a Shiny application. The Dockerfile includes steps for configuring the environment, managing dependencies, and running the Shiny app.</p>
<hr />
<div class="sourceCode" id="cb1"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb1-1"><a href="dockerfile-documentation.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> rocker/r-ver:4.2.3</span></code></pre></div>
<ul>
<li><strong>Base Image</strong>: Uses the <code>rocker/r-ver</code> base image with R version 4.2.3 as the foundation for the container.</li>
</ul>
<hr />
<div class="sourceCode" id="cb2"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb2-1"><a href="dockerfile-documentation.html#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">&quot;Julien Barde &lt;julien.barde@ird.fr&gt;&quot;</span></span></code></pre></div>
<ul>
<li><strong>Maintainer Information</strong>: Adds metadata about the person maintaining this Dockerfile.</li>
</ul>
<hr />
<div class="sourceCode" id="cb3"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb3-1"><a href="dockerfile-documentation.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="dt">\</span></span>
<span id="cb3-2"><a href="dockerfile-documentation.html#cb3-2" aria-hidden="true" tabindex="-1"></a>    sudo <span class="dt">\</span></span>
<span id="cb3-3"><a href="dockerfile-documentation.html#cb3-3" aria-hidden="true" tabindex="-1"></a>    pandoc <span class="dt">\</span></span>
<span id="cb3-4"><a href="dockerfile-documentation.html#cb3-4" aria-hidden="true" tabindex="-1"></a>    pandoc-citeproc <span class="dt">\</span></span>
<span id="cb3-5"><a href="dockerfile-documentation.html#cb3-5" aria-hidden="true" tabindex="-1"></a>    libssl-dev <span class="dt">\</span></span>
<span id="cb3-6"><a href="dockerfile-documentation.html#cb3-6" aria-hidden="true" tabindex="-1"></a>    libcurl4-gnutls-dev <span class="dt">\</span></span>
<span id="cb3-7"><a href="dockerfile-documentation.html#cb3-7" aria-hidden="true" tabindex="-1"></a>    libxml2-dev <span class="dt">\</span></span>
<span id="cb3-8"><a href="dockerfile-documentation.html#cb3-8" aria-hidden="true" tabindex="-1"></a>    libudunits2-dev <span class="dt">\</span></span>
<span id="cb3-9"><a href="dockerfile-documentation.html#cb3-9" aria-hidden="true" tabindex="-1"></a>    libproj-dev <span class="dt">\</span></span>
<span id="cb3-10"><a href="dockerfile-documentation.html#cb3-10" aria-hidden="true" tabindex="-1"></a>    libgeos-dev <span class="dt">\</span></span>
<span id="cb3-11"><a href="dockerfile-documentation.html#cb3-11" aria-hidden="true" tabindex="-1"></a>    libgdal-dev <span class="dt">\</span></span>
<span id="cb3-12"><a href="dockerfile-documentation.html#cb3-12" aria-hidden="true" tabindex="-1"></a>    libv8-dev <span class="dt">\</span></span>
<span id="cb3-13"><a href="dockerfile-documentation.html#cb3-13" aria-hidden="true" tabindex="-1"></a>    libsodium-dev <span class="dt">\</span></span>
<span id="cb3-14"><a href="dockerfile-documentation.html#cb3-14" aria-hidden="true" tabindex="-1"></a>    libsecret-1-dev <span class="dt">\</span></span>
<span id="cb3-15"><a href="dockerfile-documentation.html#cb3-15" aria-hidden="true" tabindex="-1"></a>    git <span class="dt">\</span></span>
<span id="cb3-16"><a href="dockerfile-documentation.html#cb3-16" aria-hidden="true" tabindex="-1"></a>    libnetcdf-dev <span class="dt">\</span></span>
<span id="cb3-17"><a href="dockerfile-documentation.html#cb3-17" aria-hidden="true" tabindex="-1"></a>    curl <span class="dt">\</span></span>
<span id="cb3-18"><a href="dockerfile-documentation.html#cb3-18" aria-hidden="true" tabindex="-1"></a>    libjq-dev <span class="dt">\</span></span>
<span id="cb3-19"><a href="dockerfile-documentation.html#cb3-19" aria-hidden="true" tabindex="-1"></a>    cmake <span class="dt">\</span></span>
<span id="cb3-20"><a href="dockerfile-documentation.html#cb3-20" aria-hidden="true" tabindex="-1"></a>    protobuf-compiler <span class="dt">\</span></span>
<span id="cb3-21"><a href="dockerfile-documentation.html#cb3-21" aria-hidden="true" tabindex="-1"></a>    libprotobuf-dev <span class="dt">\</span></span>
<span id="cb3-22"><a href="dockerfile-documentation.html#cb3-22" aria-hidden="true" tabindex="-1"></a>    librdf0 <span class="dt">\</span></span>
<span id="cb3-23"><a href="dockerfile-documentation.html#cb3-23" aria-hidden="true" tabindex="-1"></a>    librdf0-dev <span class="dt">\</span></span>
<span id="cb3-24"><a href="dockerfile-documentation.html#cb3-24" aria-hidden="true" tabindex="-1"></a>    redland-utils <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb3-25"><a href="dockerfile-documentation.html#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apt-get</span> clean</span></code></pre></div>
<ul>
<li><strong>System Dependencies</strong>:
<ul>
<li>Installs system libraries required for building and running the Shiny app.</li>
<li>Includes dependencies like <code>pandoc</code> for document conversion, <code>libssl-dev</code> for SSL/TLS, and others for geospatial and network operations.</li>
</ul></li>
</ul>
<hr />
<div class="sourceCode" id="cb4"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb4-1"><a href="dockerfile-documentation.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">install2.r</span> <span class="at">--error</span> <span class="at">--skipinstalled</span> <span class="at">--ncpus</span> <span class="at">-1</span> httpuv</span></code></pre></div>
<ul>
<li>Installs the <code>httpuv</code> R package, which is a core dependency for Shiny apps.</li>
</ul>
<hr />
<div class="sourceCode" id="cb5"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb5-1"><a href="dockerfile-documentation.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /root/tunaatlas_pie_map_shiny</span></code></pre></div>
<ul>
<li><strong>Set Working Directory</strong>: Specifies the working directory inside the container.</li>
</ul>
<hr />
<div class="sourceCode" id="cb6"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb6-1"><a href="dockerfile-documentation.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> download_GTA_data.R ./download_GTA_data.R</span>
<span id="cb6-2"><a href="dockerfile-documentation.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">Rscript</span> download_GTA_data.R</span></code></pre></div>
<ul>
<li><strong>Data Preparation</strong>:
<ul>
<li>Copies a script into the container to download necessary datasets, from .zip or .csv files on github.</li>
<li>Executes the script using <code>Rscript</code>.</li>
</ul></li>
</ul>
<hr />
<div class="sourceCode" id="cb7"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb7-1"><a href="dockerfile-documentation.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;install.packages(&#39;remotes&#39;, repos=&#39;https://cran.r-project.org/&#39;)&quot;</span> </span>
<span id="cb7-2"><a href="dockerfile-documentation.html#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_version(&#39;downloader&#39;, version = &#39;0.4&#39;, upgrade = &#39;never&#39;, repos = &#39;https://cran.r-project.org/&#39;)&quot;</span></span>
<span id="cb7-3"><a href="dockerfile-documentation.html#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;remotes::install_version(&#39;readr&#39;, version = &#39;2.1.5&#39;, upgrade = &#39;never&#39;,  repos = &#39;https://cran.r-project.org/&#39;)&quot;</span></span></code></pre></div>
<ul>
<li><strong>Downloading packages for downloading big data</strong>:
<ul>
<li>Download packages to download data from DOI (around 300 MB).</li>
<li>This can be done using other packages, it can also be integrated to a script.</li>
</ul></li>
</ul>
<hr />
<div class="sourceCode" id="cb8"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb8-1"><a href="dockerfile-documentation.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Echo the DOI_CSV_HASH for debugging and to to stop cache if DOI.csv has changed (takes in input the hash of the DOI.csv file created in yml)</span></span>
<span id="cb8-2"><a href="dockerfile-documentation.html#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> DOI_CSV_HASH</span>
<span id="cb8-3"><a href="dockerfile-documentation.html#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="bu">echo</span> <span class="st">&quot;DOI_CSV_HASH=</span><span class="va">${DOI_CSV_HASH}</span><span class="st">&quot;</span></span>
<span id="cb8-4"><a href="dockerfile-documentation.html#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="dockerfile-documentation.html#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Create data repository to copy DOI.csv, a file listing the dataset to download from zenodo</span></span>
<span id="cb8-6"><a href="dockerfile-documentation.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">mkdir</span> <span class="at">-p</span> data </span>
<span id="cb8-7"><a href="dockerfile-documentation.html#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="dockerfile-documentation.html#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">## Copy the CSV containing the data to download</span></span>
<span id="cb8-9"><a href="dockerfile-documentation.html#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">## Copy the script downloading the data from the CSV</span></span>
<span id="cb8-10"><a href="dockerfile-documentation.html#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> data/DOI.csv ./data/DOI.csv </span>
<span id="cb8-11"><a href="dockerfile-documentation.html#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> update_data.R ./update_data.R </span>
<span id="cb8-12"><a href="dockerfile-documentation.html#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">Rscript</span> update_data.R </span></code></pre></div>
<p>This download data from zenodo taking in input a .csv file providing every DOI of the dataset to be downloaded. As this operation takes time and bandwidth, we use a cache. For this we check the DOI.csv file and if it didn’t change this operation is not reran.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb9-1"><a href="dockerfile-documentation.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">## ARG defines a constructor argument called RENV_PATHS_ROOT. Its value is passed from the YAML file. An initial value is set up in case the YAML does not provide one</span></span>
<span id="cb9-2"><a href="dockerfile-documentation.html#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> RENV_PATHS_ROOT=/root/.cache/R/renv</span>
<span id="cb9-3"><a href="dockerfile-documentation.html#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> RENV_PATHS_ROOT=${RENV_PATHS_ROOT}</span>
<span id="cb9-4"><a href="dockerfile-documentation.html#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="dockerfile-documentation.html#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Set environment variables for renv cache</span></span>
<span id="cb9-6"><a href="dockerfile-documentation.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> RENV_PATHS_CACHE=${RENV_PATHS_ROOT}</span>
<span id="cb9-7"><a href="dockerfile-documentation.html#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="dockerfile-documentation.html#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">## Echo the RENV_PATHS_ROOT for logging</span></span>
<span id="cb9-9"><a href="dockerfile-documentation.html#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="bu">echo</span> <span class="st">&quot;RENV_PATHS_ROOT=</span><span class="va">${RENV_PATHS_ROOT}</span><span class="st">&quot;</span></span>
<span id="cb9-10"><a href="dockerfile-documentation.html#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="bu">echo</span> <span class="st">&quot;RENV_PATHS_CACHE=</span><span class="va">${RENV_PATHS_CACHE}</span><span class="st">&quot;</span></span>
<span id="cb9-11"><a href="dockerfile-documentation.html#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="dockerfile-documentation.html#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">## Define the build argument for the hash of renv.lock to stop cache if renv.lock has changed</span></span>
<span id="cb9-13"><a href="dockerfile-documentation.html#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> RENV_LOCK_HASH</span>
<span id="cb9-14"><a href="dockerfile-documentation.html#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="bu">echo</span> <span class="st">&quot;RENV_LOCK_HASH=</span><span class="va">${RENV_LOCK_HASH}</span><span class="st">&quot;</span></span>
<span id="cb9-15"><a href="dockerfile-documentation.html#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="dockerfile-documentation.html#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">## Create the renv cache directory</span></span>
<span id="cb9-17"><a href="dockerfile-documentation.html#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">mkdir</span> <span class="at">-p</span> <span class="va">${RENV_PATHS_ROOT}</span></span>
<span id="cb9-18"><a href="dockerfile-documentation.html#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="dockerfile-documentation.html#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">## Install renv package that records the packages used in the shiny app</span></span>
<span id="cb9-20"><a href="dockerfile-documentation.html#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;install.packages(&#39;renv&#39;, repos=&#39;https://cran.r-project.org/&#39;)&quot;</span></span>
<span id="cb9-21"><a href="dockerfile-documentation.html#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="dockerfile-documentation.html#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co">## Copy renv configuration and lockfile</span></span>
<span id="cb9-23"><a href="dockerfile-documentation.html#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> renv.lock ./</span>
<span id="cb9-24"><a href="dockerfile-documentation.html#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> renv/activate.R renv/</span>
<span id="cb9-25"><a href="dockerfile-documentation.html#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> renv/settings.json renv/</span>
<span id="cb9-26"><a href="dockerfile-documentation.html#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="dockerfile-documentation.html#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co">## Restore renv packages</span></span>
<span id="cb9-28"><a href="dockerfile-documentation.html#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;renv::activate()&quot;</span> </span>
<span id="cb9-29"><a href="dockerfile-documentation.html#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co">## Used to setup the environment (with the path cache)</span></span>
<span id="cb9-30"><a href="dockerfile-documentation.html#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;renv::restore()&quot;</span> </span>
<span id="cb9-31"><a href="dockerfile-documentation.html#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="dockerfile-documentation.html#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co">## Copy the rest of the application code</span></span>
<span id="cb9-33"><a href="dockerfile-documentation.html#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> . .</span></code></pre></div>
<p>Similarly, if renv.lock as not changed, all the downloading of the packages will not be done again as the cache image already contains them. We then activate the project to use renv and thus to load the corresonding packages. This action can be put at the all beginning of the dockerfile if the packages are the input that are the less likely to change. NB: Any change in the Dockerfile will remove the use of the cache for the next creation.
The ARG RENV_LOCK_HASH corresponds in the yml to $(sha256sum renv.lock | cut -d’ ’ -f1).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb10-1"><a href="dockerfile-documentation.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Create the default dataset from DOI and GTA data loading to make launching faster (use of qs for loading and data.table for tidying) </span></span>
<span id="cb10-2"><a href="dockerfile-documentation.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">Rscript</span> ./create_or_load_default_dataset.R </span></code></pre></div>
<p>Those lines are specific to this shiny app but allows the loading of the dataset and the tidying to do it before launching the app and thus reduce the laucning time.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb11-1"><a href="dockerfile-documentation.html#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="dockerfile-documentation.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Expose port 3838 for the Shiny app</span></span>
<span id="cb11-3"><a href="dockerfile-documentation.html#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 3838</span>
<span id="cb11-4"><a href="dockerfile-documentation.html#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="dockerfile-documentation.html#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Create directories for configuration</span></span>
<span id="cb11-6"><a href="dockerfile-documentation.html#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">mkdir</span> <span class="at">-p</span> /etc/tunaatlas_pie_map_shiny/</span>
<span id="cb11-7"><a href="dockerfile-documentation.html#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="dockerfile-documentation.html#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;library(sf); library(tmap); library(dplyr); library(ggplot2); library(leaflet); library(data.table)&quot;</span></span></code></pre></div>
<p>Exposure and directories are mandatory for the launching.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb12-1"><a href="dockerfile-documentation.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">&quot;library(sf); library(tmap); library(dplyr); library(ggplot2); library(leaflet); library(data.table)&quot;</span></span></code></pre></div>
<p>Those lines are to load big packages prior of the launching to avoid time consuming however it is not clear yet if it works well.</p>
<p>Some good practice can help reducing the time of the launching of the application, they will be detailled in another documentation file.</p>
</div>
<div id="final-steps" class="section level2 hasAnchor" number="1.2">
<h2><span class="header-section-number">1.2</span> Final Steps<a href="dockerfile-documentation.html#final-steps" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>At the end of the Dockerfile:
- The <code>CMD</code> statement ensures the Shiny app starts when the container runs:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb13-1"><a href="dockerfile-documentation.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">&quot;R&quot;</span>, <span class="st">&quot;-e&quot;</span>, <span class="st">&quot;shiny::runApp(&#39;/root/tunaatlas_pie_map_shiny&#39;, port=3838, host=&#39;0.0.0.0&#39;)&quot;</span>]</span></code></pre></div>
<ul>
<li>The port <code>3838</code> is exposed to allow access to the app.</li>
</ul>
<hr />

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="github-actions-yaml-documentation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Documentation on the Dockerfile and the YAML for the Shiny App.pdf", "Documentation on the Dockerfile and the YAML for the Shiny App.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection",
"toc_depth": 2
}
});
});
</script>

</body>

</html>
